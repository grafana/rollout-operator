# How to release a new version

1. Open and merge a PR
   - Update `CHANGELOG.md` as required 
   - Update [images.libsonnet](operations/rollout-operator/images.libsonnet) - set the version based off what the following tag will be
   - Run `make build-jsonnet-tests` to update the jsonnet tests to include the new image version

2. Create a new tag that follows semantic versioning:
    ```bash
    $ tag=v0.1.0
    $ git tag -s "${tag}" -m "${tag}"
    $ git push origin "${tag}"
    ```

3. The [CI workflow](.github/workflows/ci.yaml) will run automatically.
   It will build and push the image to [Docker Hub](https://hub.docker.com/r/grafana/rollout-operator), and create a [GitHub release](https://github.com/grafana/rollout-operator/releases) with release notes.

4. Update the rollout-operator Helm Chart:
   - Repository https://github.com/grafana/helm-charts/tree/main/charts/rollout-operator
   - [Example PR](https://github.com/grafana/helm-charts/pull/3177/files)

5. Update the mimir-distributed Helm Chart and mimir jsonnet vendoring
   - Repository https://github.com/grafana/mimir/tree/main/operations/helm/charts/mimir-distributed/
   - [Example PR](https://github.com/grafana/mimir/pull/12996)
   
Edit the `mimir-distributed/Chart.yaml` and update the chart version. The remainder of the modified files are generated by running `helm-docs` and re-generating test cases. See [Makefile](https://github.com/grafana/mimir/blob/main/Makefile)

Note - Mimir vendors jsonnet from the rollout-operator. Mimir has jsonnet tests which generate manifest files for various configurations and this uses the [jsonnet-bundler](https://github.com/jsonnet-bundler/jsonnet-bundler) `jb` to download vendored files.

Due to this [issue#42](https://github.com/jsonnet-bundler/jsonnet-bundler/issues/142), `jb` will download files based on the `jsonnetfile.json` dependencies and will ignore the version hash in `jsonnet.lock.json`.

As such, the following workaround is required in Mimir;

- `cd operations/mimir`
- edit `jsonnetfile.json` and set the `rollout-operator` version to `main`

```
{
      "source": {
        "git": {
          "remote": "https://github.com/grafana/rollout-operator.git",
          "subdir": "operations/rollout-operator"
        }
      },
      "version": "4d563316583fdc8120c6ee7dfb393bb59a537bae" <-- set this to "main"
    }

```

- `jb update github.com/grafana/rollout-operator/operations/rollout-operator@main`
- obtain the new version hash - `grep -A 5 "rollout-operator.git" jsonnetfile.lock.json | grep version`
- edit `jsonnetfile.json` and set the `rollout-operator` version to the hash obtained above
- jsonnet tests may need to be refreshed. See [Makefile](https://github.com/grafana/mimir/blob/main/Makefile)

